# =============================================================================
# T1D PINN Docker Setup (Simplified)
# Training container only - for reproducible builds and CV demonstration
# =============================================================================
#
# NOTE: This is kept minimal. For actual training, we use EC2 + S3:
#   - EC2 GPU instance for training
#   - S3 bucket for results storage
#   - No orchestration services needed for this research project
#
# =============================================================================

services:
  # ===========================================================================
  # Training Service - Containerized training environment
  # ===========================================================================
  training:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: t1d-pinn:latest
    container_name: t1d-training
    volumes:
      - ./data:/data:ro                    # Read-only data mount
      - ./results:/results:rw              # Read-write results
      - ./configs:/app/configs:ro          # Read-only configs
      - ./src:/app/src:ro                  # Read-only source code
      - ./scripts:/app/scripts:ro          # Read-only scripts
    environment:
      - PYTHONPATH=/app
      - TF_FORCE_GPU_ALLOW_GROWTH=true
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
      # S3 upload settings (optional)
      - T1D_S3_BUCKET=${T1D_S3_BUCKET:-}
      - AWS_REGION=${AWS_REGION:-eu-west-2}
    # For GPU support (requires nvidia-docker):
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

# =============================================================================
# Usage:
# =============================================================================
# Build:
#   docker-compose build
#
# Run training:
#   docker-compose run training python scripts/train_inverse.py \
#     --config configs/pinn_inverse.yaml --patient 5
#
# Run with S3 upload:
#   docker-compose run -e T1D_S3_BUCKET=my-bucket training python scripts/train_inverse.py \
#     --config configs/pinn_inverse.yaml --patient 5 --upload-s3
#
# Clean up:
#   docker-compose down
# =============================================================================
